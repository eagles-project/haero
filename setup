#!/usr/bin/env bash

# This script creates a build directory and sticks a config.sh script into it.
# Then config.sh can be edited and run within the build directory.

# Print usage info.
if [ "$1" = "" ]; then
  echo "setup: Creates a build directory with a configuration file."
  echo "Usage: setup build_dir"
  exit 1
fi

# Create the build directory if it doesn't exist.
if [ ! -d $1 ]; then
  mkdir -p $1
fi

# Copy our template config script into place.
echo -e "#!/usr/bin/env bash\n" > $1/config.sh
echo "SOURCE_DIR=$PWD" >> $1/config.sh
cat <<EOT >> $1/config.sh
# ^^^^^^ location of haero source code.

# config.sh -- A CMake configuration script.
# Edit this file to change the parameters in your build. Uncomment exactly one
# value for each parameter.

#-----------------------------------------------------------------------------
#                             Installation prefix
#-----------------------------------------------------------------------------
PREFIX=$PWD/$1

#-----------------------------------------------------------------------------
#                             Third-party libraries
#-----------------------------------------------------------------------------
# Usually you don't need to set these. But we provide this ability in case
# another project (e.g. SCREAM) needs to build this one and use its own
# libraries. We also use these in our automatic testing environment. If any one
# of these variables is supplied for a library, all must be supplied.

#KOKKOS_DIR=/path/to/kokkos

#EKAT_INCLUDE_DIR=/path/to/ekat/includes
#EKAT_LIBRARY=/path/to/libekat.a

#OPENBLAS_INCLUDE_DIR=/path/to/openblas/includes
#OPENBLAS_LIBRARY=/path/to/libopenblas.a

#TINES_INCLUDE_DIR=/path/to/tines/includes
#TINES_LIBRARY=/path/to/libtines.a

#TCHEM_INCLUDE_DIR=/path/to/tchem/includes
#TCHEM_LIBRARY=/path/to/libtchemcore.a

# If you're using your own build of Skywalker, make sure its precision matches
# Haero's (see PRECISION below).
#SKYWALKER_INCLUDE_DIR=/path/to/skywalker/includes
#SKYWALKER_LIBRARY=/path/to/libskywalker_double.a
#SKYWALKER_F90_LIBRARY=/path/to/libskywalker_f90_double.a

#-----------------------------------------------------------------------------
#                             Inter-Node Parallelism (MPI)
#-----------------------------------------------------------------------------

# Build with MPI for parallel simulations.
# This is currently needed by the EKAT library. We can get rid of it as
# a requirement down the line if necessary.
ENABLE_MPI=ON

# The name of the program used to execute MPI programs. Some machines require
# this invocation even for single-process runs.
MPI_EXEC=
#MPI_EXEC=mpiexec

# The flag used by MPI_EXEC to indicate the number of processes to use.
MPI_NP_FLAG=
#MPI_NP_FLAG=-n

# Any extra arguments that need to be passed to MPI_EXEC.
MPI_EXTRA_ARGS=

#-----------------------------------------------------------------------------
#                             On-Node Parallelism (Kokkos)
#-----------------------------------------------------------------------------

# Set this to ON to dispatch aerosol calculations to a GPU.
ENABLE_GPU=OFF

# Select one of the following device architectures based on the above:
# (These options are taken from kokkos_arch.cmake)
DEVICE_ARCH=AMDAVX          # AMD chip (CPU)
#DEVICE_ARCH=ARMV80          # ARMv8.0 Compatible CPU (CPU)
#DEVICE_ARCH=ARMV81          # ARMv8.1 Compatible CPU (CPU)
#DEVICE_ARCH=ARMV8_THUNDERX  # ARMv8 Cavium ThunderX CPU (CPU)
#DEVICE_ARCH=ARMV8_THUNDERX2 # ARMv8 Cavium ThunderX2 CPU (CPU)
#DEVICE_ARCH=A64FX           # ARMv8.2 with SVE Suport (CPU)
#DEVICE_ARCH=WSM             # Intel Westmere CPU (CPU)
#DEVICE_ARCH=SNB             # Intel Sandy/Ivy Bridge CPUs (CPU)
#DEVICE_ARCH=HSW             # Intel Haswell CPUs (CPU)
#DEVICE_ARCH=BDW             # Intel Broadwell Xeon E-class CPUs (CPU)
#DEVICE_ARCH=SKX             # Intel Sky Lake Xeon E-class HPC CPUs (AVX512) (CPU)
#DEVICE_ARCH=KNC             # Intel Knights Corner Xeon Phi (CPU)
#DEVICE_ARCH=KNL             # Intel Knights Landing Xeon Phi (CPU)
#DEVICE_ARCH=BGQ             # IBM Blue Gene Q (CPU)
#DEVICE_ARCH=POWER7          # IBM POWER7 CPUs (CPU)
#DEVICE_ARCH=POWER8          # IBM POWER8 CPUs (CPU)
#DEVICE_ARCH=POWER9          # IBM POWER9 CPUs (CPU)
#DEVICE_ARCH=KEPLER30        # NVIDIA Kepler generation CC 3.0 (CUDA)
#DEVICE_ARCH=KEPLER32        # NVIDIA Kepler generation CC 3.2 (CUDA)
#DEVICE_ARCH=KEPLER35        # NVIDIA Kepler generation CC 3.5 (CUDA)
#DEVICE_ARCH=KEPLER37        # NVIDIA Kepler generation CC 3.7 (CUDA)
#DEVICE_ARCH=MAXWELL50       # NVIDIA Maxwell generation CC 5.0 (CUDA)
#DEVICE_ARCH=MAXWELL52       # NVIDIA Maxwell generation CC 5.2 (CUDA)
#DEVICE_ARCH=MAXWELL53       # NVIDIA Maxwell generation CC 5.3 (CUDA)
#DEVICE_ARCH=PASCAL60        # NVIDIA Pascal generation CC 6.0 (CUDA)
#DEVICE_ARCH=PASCAL61        # NVIDIA Pascal generation CC 6.1 (CUDA)
#DEVICE_ARCH=VOLTA70         # NVIDIA Volta generation CC 7.0 (CUDA)
#DEVICE_ARCH=VOLTA72         # NVIDIA Volta generation CC 7.2 (CUDA)
#DEVICE_ARCH=TURING75        # NVIDIA Turing generation CC 7.5 (CUDA)
#DEVICE_ARCH=AMPERE80        # NVIDIA Ampere generation CC 8.0 (CUDA)
#DEVICE_ARCH=ZEN             # AMD Zen architecture (CPU)
#DEVICE_ARCH=ZEN2            # AMD Zen2 architecture (CPU)
#DEVICE_ARCH=VEGA900         # AMD GPU MI25 GFX900 (HIP)
#DEVICE_ARCH=VEGA906         # AMD GPU MI50/MI60 GFX906 (HIP)
#DEVICE_ARCH=VEGA908         # AMD GPU (HIP)
#DEVICE_ARCH=INTEL_GEN       # Intel GPUs Gen9+ (GPU)

#-----------------------------------------------------------------------------
#                         Build features and parameters
#-----------------------------------------------------------------------------

# Set this to
# * 'Debug' for development (debugging symbols, no optimization)
# * 'Release' for production (no symbols, optimization).
BUILD_TYPE=Debug

# This controls how many floating point numbers we can operate on simultaneously
# using SIMD vector operations. This is mostly for use on CPUs, but some newer
# GPUs also support vectorization. NOTE: Fortran implementations of aerosol
# processes are only supported for a PACK_SIZE of 1.
PACK_SIZE=1

# Set this to
# * 'double' for double precision
# * 'single' for single precision
PRECISION=double

# Set this to ON to enable building the chemistry solver and driver.
ENABLE_CHEMISTRY=OFF

# Uncomment this if you want really verbose builds.
#VERBOSE=ON

#-----------------------------------------------------------------------------
#                          MAM4 box model testing setup
#-----------------------------------------------------------------------------

# Set this to ON to enable testing against MAM4 box model parameterizations.
ENABLE_MAM4BOX=OFF

# If Set this to a local directory containing a clone of the mam_refactor repo.
#MAM4BOX_DIR=/path/to/mam_box_model_source

#-----------------------------------------------------------------------------
#                                   Compilers
#-----------------------------------------------------------------------------

CXX=c++
CC=cc
FC=gfortran

# Override compilers here (ONLY if you know what you're doing!).

# C++ compiler.
#CXX=c++

# Fortran compiler.
#FC=gfortran

# C compiler.
#CC=cc

#-----------------------------------------------------------------------------
#                   Don't change anything below here.
#-----------------------------------------------------------------------------

# Are we on a special machine?
pushd "\$SOURCE_DIR"/machines >& /dev/null
for MACHINE_FILE in \$(ls)
do
  MACHINE=\${MACHINE_FILE/\.sh/}
  if echo `hostname` | grep -q "\$MACHINE"; then
    echo "Found machine file \$MACHINE_FILE. Setting up environment for \$MACHINE..."
    . ./\$MACHINE.sh
  fi
done
popd >& /dev/null

# We use good old-fashioned UNIX makefiles.
GENERATOR="Unix Makefiles"

OPTIONS=""
if [ "\$ENABLE_MPI" = "ON" ]; then
  if [ ! "\$MPI_EXEC" = "" ]; then
    if [ "\$MPI_NP_FLAG" = "" ]; then
      echo "Error: MPI_NP_FLAG must be set if MPI_EXEC is set."
      exit 1
    fi
    OPTIONS="\$OPTIONS -DHAERO_MPI_EXEC=\$MPI_EXEC -DHAERO_MPI_NP_FLAG=\$MPI_NP_FLAG"
    if [ ! "\$MPI_EXTRA_ARGS" = "" ]; then
      OPTIONS="\$OPTIONS -DHAERO_MPI_EXTRA_ARGS=\$MPI_EXTRA_ARGS"
    fi
  fi
fi
if [ "\$VERBOSE" = "ON" ]; then
  OPTIONS="\$OPTIONS -DCMAKE_VERBOSE_MAKEFILE=ON"
fi

# Configure ekat if needed.
if [ ! "\$EKAT_LIBRARY_DIR" = "" -o ! "\$EKAT_INCLUDE_DIR" = "" -o ! "\$EKAT_LIBRARY" = "" ]; then
  if [ "\$EKAT_LIBRARY" = "" ]; then
    echo "Error: EKAT_LIBRARY must be specified for a custom EKAT library."
    exit 1
  fi
  if [ "\$EKAT_INCLUDE_DIR" = "" ]; then
    echo "Error: EKAT_INCLUDE_DIR must be specified for a custom EKAT library."
    exit 1
  fi
  OPTIONS="\$OPTIONS -DEKAT_LIBRARY=\$EKAT_LIBRARY_DIR/\$EKAT_LIBRARY"
  OPTIONS="\$OPTIONS -DEKAT_INCLUDE_DIR=\$EKAT_INCLUDE_DIR"
fi

# Configure OpenBLAS if needed.
if [ ! "\$OPENBLAS_LIBRARY_DIR" = "" -o ! "\$OPENBLAS_INCLUDE_DIR" = "" -o ! "\$OPENBLAS_LIBRARY" = "" ]; then
  if [ "\$OPENBLAS_LIBRARY" = "" ]; then
    echo "Error: OPENBLAS_LIBRARY must be specified for a custom OpenBLAS library."
    exit 1
  fi
  if [ "\$OPENBLAS_INCLUDE_DIR" = "" ]; then
    echo "Error: OPENBLAS_INCLUDE_DIR must be specified for a custom OpenBLAS library."
    exit 1
  fi
  OPTIONS="\$OPTIONS -DOPENBLAS_LIBRARY=\$OPENBLAS_LIBRARY_DIR/\$OPENBLAS_LIBRARY"
  OPTIONS="\$OPTIONS -DOPENBLAS_INCLUDE_DIR=\$OPENBLAS_INCLUDE_DIR"
fi

# Configure Tines if needed.
if [ ! "\$TINES_LIBRARY_DIR" = "" -o ! "\$TINES_INCLUDE_DIR" = "" -o ! "\$TINES_LIBRARY" = "" ]; then
  if [ "\$TINES_LIBRARY" = "" ]; then
    echo "Error: TINES_LIBRARY must be specified for a custom Tines library."
    exit 1
  fi
  if [ "\$TINES_INCLUDE_DIR" = "" ]; then
    echo "Error: TINES_INCLUDE_DIR must be specified for a custom Tines library."
    exit 1
  fi
  OPTIONS="\$OPTIONS -DTINES_LIBRARY=\$TINES_LIBRARY_DIR/\$TINES_LIBRARY"
  OPTIONS="\$OPTIONS -DTINES_INCLUDE_DIR=\$TINES_INCLUDE_DIR"
fi

# Configure TChem if needed.
if [ ! "\$TCHEM_LIBRARY_DIR" = "" -o ! "\$TCHEM_INCLUDE_DIR" = "" -o ! "\$TCHEM_LIBRARY" = "" ]; then
  if [ "\$TCHEM_LIBRARY" = "" ]; then
    echo "Error: TCHEM_LIBRARY must be specified for a custom TChem library."
    exit 1
  fi
  if [ "\$TCHEM_INCLUDE_DIR" = "" ]; then
    echo "Error: TCHEM_INCLUDE_DIR must be specified for a custom TChem library."
    exit 1
  fi
  OPTIONS="\$OPTIONS -DTCHEM_LIBRARY=\$TCHEM_LIBRARY_DIR/\$TCHEM_LIBRARY"
  OPTIONS="\$OPTIONS -DTCHEM_INCLUDE_DIR=\$TCHEM_INCLUDE_DIR"
fi

# Configure Skywalker if needed.
if [ ! "\$SKYWALKER_LIBRARY_DIR" = "" -o ! "\$SKYWALKER_INCLUDE_DIR" = "" -o ! "\$SKYWALKER_LIBRARY" = "" ]; then
  if [ "\$SKYWALKER_LIBRARY" = "" ]; then
    echo "Error: SKYWALKER_LIBRARY must be specified for a custom Skywalker library."
    exit 1
  fi
  if [ "\$SKYWALKER_INCLUDE_DIR" = "" ]; then
    echo "Error: SKYWALKER_INCLUDE_DIR must be specified for a custom Skywalker library."
    exit 1
  fi
  OPTIONS="\$OPTIONS -DSKYWALKER_LIBRARY=\$SKYWALKER_LIBRARY_DIR/\$SKYWALKER_LIBRARY"
  OPTIONS="\$OPTIONS -DSKYWALKER_INCLUDE_DIR=\$SKYWALKER_INCLUDE_DIR"
fi
# Configure Fortran Skywalker if needed.
if [ ! "\$SKYWALKER_F90_LIBRARY_DIR" = "" -o ! "\$SKYWALKER_INCLUDE_DIR" = "" -o ! "\$SKYWALKER_F90_LIBRARY" = "" ]; then
  if [ "\$SKYWALKER_F90_LIBRARY" = "" ]; then
    echo "Error: SKYWALKER_F90_LIBRARY must be specified for a custom Skywalker fortran library."
    exit 1
  fi
  if [ "\$SKYWALKER_INCLUDE_DIR" = "" ]; then
    echo "Error: SKYWALKER_INCLUDE_DIR must be specified for a custom Skywalker fortran library."
    exit 1
  fi
  OPTIONS="\$OPTIONS -DSKYWALKER_F90_LIBRARY=\$SKYWALKER_F90_LIBRARY_DIR/\$SKYWALKER_F90_LIBRARY"
  OPTIONS="\$OPTIONS -DSKYWALKER_INCLUDE_DIR=\$SKYWALKER_INCLUDE_DIR"
fi

# Add extra linker flags if needed.
if [ ! "\$EXTRA_LDFLAGS" = "" ]; then
  OPTIONS="\$OPTIONS -DHAERO_EXTRA_LDFLAGS=\$EXTRA_LDFLAGS"
fi

# Clear the build cache.
rm -f CMakeCache.txt

# Pass along MAM4 box model options if needed.
if [ "\$ENABLE_MAM4BOX" = "ON" ]; then
  OPTIONS="\$OPTIONS -DCMAKE_Fortran_COMPILER=\$FC -DMAM4BOX_DIR=\$MAM4BOX_DIR"
fi

# Configure the build.
cmake \
 -DCMAKE_INSTALL_PREFIX:PATH=\$PREFIX \
 -DCMAKE_BUILD_TYPE=\$BUILD_TYPE \
 -DCMAKE_C_COMPILER=\$CC \
 -DCMAKE_CXX_COMPILER=\$CXX \
 -DHAERO_ENABLE_CHEMISTRY=\$ENABLE_CHEMISTRY \
 -DHAERO_ENABLE_GPU=\$ENABLE_GPU \
 -DHAERO_ENABLE_MPI=\$ENABLE_MPI \
 -DHAERO_ENABLE_MAM4BOX=\$ENABLE_MAM4BOX \
 -DHAERO_PRECISION=\$PRECISION \
 -DHAERO_DEVICE_ARCH:STRING=\$DEVICE_ARCH \
 -DKokkos_ARCH_\$DEVICE_ARCH:BOOL=ON \
 -DHAERO_PACK_SIZE=\$PACK_SIZE \
 \$OPTIONS \
 -G "\$GENERATOR" \
 \$SOURCE_DIR
EOT

# Make config.sh executable.
chmod a+x $1/config.sh

# Give instructions.
echo "Your build directory '$1' is ready."
echo "To configure your build:"
echo "  1. cd $1"
echo "  2. Edit config.sh"
echo "  3. ./config.sh"
echo "  4. Build using 'make -j'."

