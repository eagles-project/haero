#ifndef HAERO_SKYWALKER_HPP
#define HAERO_SKYWALKER_HPP

#include <set>
#include <string>
#include <vector>

#include "haero/modal_aerosol_config.hpp"

namespace skywalker {

using Real = @HAERO_REAL_TYPE@;
using ModalAerosolConfig = haero::ModalAerosolConfig;

// Reference input data for simulations.
struct InputData {
  InputData() = delete;
  InputData(const ModalAerosolConfig& config)
    : aero_config(config), dt(0.0), total_time(0.0),
      temperature(0.0), pressure(0.0), vapor_mixing_ratio(0.0), height(0.0),
      hydrostatic_dp(0.0), planetary_boundary_layer_height(0.0),
      relative_humidity(-1) {}
  InputData(const InputData& rhs) = default;
  InputData& operator=(const InputData& rhs) = default;

  // reference to aerosol configuration
  ModalAerosolConfig aero_config;

  // timestepping parameters
  Real dt, total_time;

  // atmospheric state parameters
  Real temperature, pressure, vapor_mixing_ratio, height, hydrostatic_dp,
      planetary_boundary_layer_height;

  // Relative humidity, if given. A negative value indicates that it isn't
  // given.
  Real relative_humidity;

  // aerosol initial data

  // Modal aerosol number mixing rations [# aero molecules / kg air]
  std::vector<Real> interstitial_number_mix_ratios, cloud_number_mix_ratios;
  // Aerosol mass mixing ratios [kg aerosol / kg air]
  std::vector<Real> interstitial_aero_mmrs, cloud_aero_mmrs;
  // Gas mass mixing ratios [kg gas / kg air]
  std::vector<Real> gas_mmrs;

  // Named user-defined parameters (found in "user" blocks).
  std::map<std::string, Real> user_params;

  // Fetches the parameter with the given name. If no parameter is found, these
  // operators return a zero value (or a reference to a zeroed value).
  Real operator[](const std::string& param_name) const;
  Real& operator[](const std::string& param_name);
};

// Data structure that stores parameter walking information.
struct ParameterWalk {
  /// Constructor
  /// @param aero_config The modal aerosol configuration describing the system
  ///                    to be walked in this parameter study
  /// @param [in] program_name The name of the program using skywalker to
  ///                          perform the parameter study (e.g. "haero" or
  ///                          "mam_box_model").
  ParameterWalk(const ModalAerosolConfig& aero_config,
                const std::string& program_name)
      : aero_config(aero_config), program_name(program_name),
        ref_input(aero_config) {}
  ParameterWalk() = delete;

  // aerosol configuration
  haero::ModalAerosolConfig aero_config;

  // calling program name
  std::string program_name;

  // program-specific parameters
  std::map<std::string, std::string> program_params;

  // reference input data
  InputData ref_input;

  // ensemble: parameters to walk (name -> vector of values)
  std::map<std::string, std::vector<Real>> ensemble;

  /// Gathers all input for this parameter walk into a vector of InputData,
  /// using the parameters stored in the ensemble member above.
  /// @param excluded_params a list of names of parameters to exclude from the
  ///                        the "parameter walk" if present. These parameters
  ///                        are set to their reference values.
  std::vector<InputData> gather_inputs(const std::set<std::string>& excluded_params = {}) const;
};

// Here's a container that associates input parameters with output data.
struct OutputData {
  explicit OutputData(const haero::ModalAerosolConfig& aero_config)
      : aero_config(aero_config) {}
  OutputData() = delete;

  ModalAerosolConfig aero_config;

  // Modal aerosol number mixing rations [# aero molecules / kg air]
  std::vector<Real> interstitial_number_mix_ratios, cloud_number_mix_ratios;
  // Aerosol mass mixing ratios [kg aerosol / kg air]
  std::vector<Real> interstitial_aero_mmrs, cloud_aero_mmrs;
  // Gas mass mixing ratios [kg gas / kg air]
  std::vector<Real> gas_mmrs;

  // Miscellaneous named metrics.
  std::map<std::string, Real> metrics;

  // Fetches the parameter with the given name. If no parameter is found, this
  // operator returns a zero value.
  Real operator[](const std::string& param_name) const;
};

/// This exception class stores information about errors encountered in reading
/// data from a YAML file.
class YamlException : public std::exception {
 public:
  /// Constructs an exception containing the given descriptive message.
  YamlException(const std::string& message) : _message(message) {}

  const char* what() const throw() { return _message.c_str(); }

 private:
  std::string _message;
};

/// This function reads ensemble input from a YAML input file, producing a
/// ParameterWalk object to be used for walking parameter space. If an error is
/// encountered, this throws a skywalker::YamlException.
/// @param [in] aerosol_config A selected modal aerosol configuration that
///                            defines how the input is interpreted.
/// @param [in] filename The name of the file to be read
/// @param [in] program_name The name of the program using skywalker to perform
///                          the parameter study (e.g. "haero" or
///                          "mam_box_model").
/// @returns A set of data and metadata used by skywalker to run a parameter
///          study
ParameterWalk load_ensemble(const haero::ModalAerosolConfig& aerosol_config,
    const std::string& filename,
    const std::string& program_name);

/// This function reads ensemble input from a YAML input file, producing a
/// ParameterWalk object to be used for walking parameter space. If an error is
/// encountered, this throws a skywalker::YamlException. This version of
/// `load_ensemble` accepts the symbolic name of an aerosol configuration, or
/// "user" to indicate that only the "user" sections will be used to initialize
/// an ensemble. All parameters except user-defined parameters within InputData
/// objects in this ensemble are assumed to be zero.
/// @param [in] config_name The name of an aerosol configuration ("mamX", where
///                         X is the number of aerosol modes; "user" for user-
///                         defined configurations)
/// @param [in] filename The name of the file to be read
/// @param [in] program_name The name of the program using skywalker to perform
///                          the parameter study (e.g. "haero" or
///                          "mam_box_model").
/// @returns A set of data and metadata used by skywalker to run a parameter
///          study
ParameterWalk load_ensemble(const std::string& config_name,
    const std::string& filename, const std::string& program_name);

// Writes simulation input/output data to a Python module.
void write_py_module(const std::vector<InputData>& inputs,
                     const std::vector<OutputData>& outputs,
                     const std::string& py_module_name);

}  // namespace skywalker

#endif
